#!/usr/bin/env ruby
require "optparse"

lib_path = File.expand_path(File.join(File.dirname(__FILE__), "..", "lib"))
require File.join(lib_path, "micro_test")
include MicroTest::Color

# setup the formatters list ---------------------------------------------------
formatter_names = MicroTest.formatters.map(&:short_name).sort

# setup the options -----------------------------------------------------------
options = {}
parser = OptionParser.new do |opts|
  opts.banner = "MicroTest Usage: mt [options] /path/to/test/dir_or_file"

  desc = "Runs tests asynchronously."
  opts.on("-a", "--async", desc) { |value| options[:async] = value }

  desc = "Runs the MicroTest test suite and some additional demo tests."
  opts.on("--demo", desc) { |value| options[:demo] = value }

  desc = "The formatter to use. [#{formatter_names.join(", ")}]"
  opts.on("-f", "--formatter [FORMATTER]", desc) do |value|
    options[:formatter] = value
  end

  desc = "Stops the test run after the first failure. "
  opts.on("--fail-fast", desc) { |value| options[:fail_fast] = value }

  desc = "Starts a PRY session whenever a test fails. "
  opts.on("--pry", desc) { |value| options[:pry] = value }

  opts.on("-v", "--version", "Show version.") do
    puts "MicroTest #{MicroTest::VERSION}"
    exit 0
  end

  opts.on_tail("-h", "--help", "Show this message.") do
    puts opts
    exit 0
  end

end
parser.parse!

# apply rules to the options --------------------------------------------------
if RUBY_ENGINE == "jruby"
  if options[:pry]
    options[:pry] = nil
    puts red("Unfortunately the pry option is not available on jruby")
    puts red("due to a dependency on pry-stack_explorer & binding_of_caller.")
    puts "However, the pry workflow is awesome. Switch to #{green "mri 1.9"} to try it."
  end
end
if RUBY_ENGINE == "rbx"
  if options[:pry]
    options[:pry] = nil
    puts red("Unfortunately the pry option is not available on rubinius at this time")
    puts red("due to weird behavior related to pry & pry-stack_explorer.")
    puts "However, the pry workflow is awesome. Switch to #{green "mri 1.9"} to try it."
  end
end
if options[:async] && options[:pry]
  options[:pry] = nil
  puts red("Disabling pry while runing in async mode to avoid interleaved pry session chaos.")
end
ENV["MT_DEMO"] = "true" if options[:demo]

# setup the test path ---------------------------------------------------------
path = ARGV.last unless ARGV.last =~ /^-/
path = File.expand_path(File.join(File.dirname(__FILE__), "..", "test")) if options[:demo]
path ||= "test"
path = File.join(Dir.pwd, path) unless path =~ /^\//
unless File.exist?(path)
  puts "#{path} not found."
  puts "Please check the path and try again."
  exit 1
end
if path =~ /\.rb$/
  require path
else
  Dir[File.join(path, "**", "*.rb")].each { |path| require path }
end

# setup the formatter ---------------------------------------------------------
formatter = MicroTest.formatters.find { |f| f.short_name == options[:formatter] }
formatter ||= begin
  if options[:async]
    MicroTest.formatters.find { |f| f.short_name == "default_async" }
  else
    MicroTest.formatters.find { |f| f.short_name == "default" }
  end
end

# setup the test runner -------------------------------------------------------
runner = MicroTest::Runner.new(formatter.new, options)

# setup pry -------------------------------------------------------------------
if options[:pry]

  begin
    require "pry"
    require "pry-stack_explorer"
    require "pry-rescue"
  rescue Exception => e
    puts red(e.message)
    puts e.backtrace.join("\n")
    puts red("This can be caused when pry-stack_explorer isn't specified in the Gemfile.")
    puts red("It might also indicate that pry-stack_explorer & pry are out of sync.")
    puts red("Try different cominations of GEM versions for pry & pry-stack_explorer.")
    exit 1
  end

  Pry.config.hooks.add_hook :before_session, :print_instructions do |_, _, _pry_|
    puts
    puts " Pry session started"
    puts gray("".ljust(80, "-"))
    puts " #{gray "Test Failures:"} Type #{green "up"} to see the line that failed"
    puts " #{gray "Exceptions:"} Type #{green "whereami"} to get your bearings"
    puts
    puts " Type #{green "exit"} or #{green "<CTL-D>"} to continue"
    puts gray("".ljust(80, "-"))
    puts
  end

  exit Pry.rescue { runner.run }
else
  exit runner.run
end

